<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap, CSS & Icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-uWxY/CJNBR+1zjPWmfnSnVxwRheevXITnMqoEIeG1LJrdI0GlVs/9cVSyPYXdcSF" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <title>Checkout | IntelAtlas</title>
</head>
<body> 
    <!-- Include the PayPal JavaScript SDK; replace "test" with your own sandbox Business account app client ID -->
    <script src="https://www.paypal.com/sdk/js?client-id=ATTvB3Pjt7K6c0Pm7km72twwH3GI-3FnaqZvgwWbqfRU-RmndDwSuRXN21dFmc0-hpDxQC4P3MP_wC2H&currency=USD&disable-funding=credit"></script>
    <div class="container">
        <main>
            <div class="py-5 text-center">
                <a href="/"><img class="d-block mx-auto mb-4" src="../assets/img/logo.png" alt="logo" height="100"></a>
                <h2>Checkout</h2>
                <p class="lead">You have 14 days to return your product if not satisfied.</p>
            </div>
            <div class="row g-5">
                <div class="col-md-7 col-lg-8">
                    <h4 class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-primary">Your cart</span>
                        <span class="badge bg-primary rounded-pill qtyCart">2</span>
                    </h4>
                    <ul class="list-group mb-3" id="cartListItem"></ul>
                    <li class="list-group-item d-flex justify-content-between lh-sm cartItemClone d-none">
                        <img src="#" alt="twbs" height="32" class="rounded flex-shrink-0 prdImg">

                        <div class="input-group input-group-sm contBtn ms-2" style="width:90px; height: fit-content;">
                            <button class="btn btn-outline-secondary btnDown" type="button">-</button>
                            <input type="text" class="form-control intQty text-center" disabled>
                            <button class="btn btn-outline-secondary btnUp" type="button">+</button>
                        </div>

                        <div class="w-50 ms-2">
                            <h6 class="my-0 prodName">Women's glove</h6>
                        </div>
                        <span class="text-muted prodPrice">$45.50</span>
                        <a href="javascript:void(0);" class="text-danger btnRemove ms-2">X</a>
                    </li>
                    <p class="text-end mb-0">Shipping Cost <span class="lblShipCost"></span></p>
                    <p class="lead text-danger text-end" id="lblTotal"></p>
                </div>
                <div class="col-md-5 col-lg-4">
                    <div class="mt-md-5" id="paypal-button-container"></div>          
                </div>
            </div>
        </main>

        <footer class="my-5 pt-5 text-muted text-center text-small">
          <p class="mb-1">&copy; 2021 Intel Atlas</p>
        </footer>
    </div> 

<!-- Option 1: Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-kQtW33rZJAHjgefvhyyzcGF3C5TFyBQBA13V1RKPf4uH+bwyzQxZ6CmMZHmNBEfJ" crossorigin="anonymous"></script>
<!-- Jquery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

<script type="text/javascript">
    var formatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2
        }),
        grantotal = 0,
        ship_price = 0,
        orderDetails = [];

    $(document).ready(function(){
        printList();
        countCartItem();
    });

    function printList() {
        let currentCart = JSON.parse(localStorage.getItem("currentCart"));
        $("#cartListItem").html("");

        $.each( currentCart, function( index, item){
            let listItem = $(".cartItemClone").clone();

            listItem.find(".prdImg").attr("src", `../${item.thumbnail}`);
            listItem.find(".prodName").html(item.name);
            listItem.find(".prodPrice").html(formatter.format(item.price));
            listItem.find(".intQty").val(item.qty);

            listItem.find(".contBtn").data("item", item);
            listItem.data("item", item);

            listItem.removeClass("d-none cartItemClone");
            $(listItem).appendTo("#cartListItem");
        });

        $(".btnDown").unbind().click( function () {
            let currentCart = JSON.parse(localStorage.getItem("currentCart")),
                data = $(this).parent().data("item"),
                actualQty = currentCart[data.id].qty;

            if(actualQty > 1){
                currentCart[data.id].qty = actualQty - 1;
                localStorage.setItem("currentCart", JSON.stringify(currentCart));
                printList();
            }
        });

        $(".btnUp").unbind().click( function () {
            let currentCart = JSON.parse(localStorage.getItem("currentCart")),
                data = $(this).parent().data("item"),
                actualQty = currentCart[data.id].qty;

            if(actualQty > 0){
                currentCart[data.id].qty = actualQty + 1;
                localStorage.setItem("currentCart", JSON.stringify(currentCart));
                printList();
            }
        });

        $(".btnRemove").unbind().click( function(){
            let currentCart = JSON.parse(localStorage.getItem("currentCart")),
                data = $(this).parent().data("item");

            delete currentCart[data.id];
            localStorage.setItem("currentCart", JSON.stringify(currentCart));
            printList();
            countCartItem();
        });

        resumen();
    }

    function countCartItem(){
        let currentCart = JSON.parse(localStorage.getItem("currentCart"));
        if(currentCart)
            $(".qtyCart").html(Object.keys(currentCart).length);
    }

    function resumen(){
        grantotal = 0;
        ship_price = 0;
        orderDetails = [];

        let currentCart = JSON.parse(localStorage.getItem("currentCart"));

        $.each(currentCart, function(index, item){
            grantotal += parseFloat(parseFloat(item.price) * parseFloat(item.qty));

            let row = {
                "product_id": index,
                "price": item.price,
                "quantity": item.qty,
                "amount" : parseFloat(parseFloat(item.price) * parseFloat(item.qty))
            };

            orderDetails.push(row);
        });

        let objData = {
            "_method":"Get"
        };

        $.post("../core/controllers/setting.php", objData, function(result) {
            let data = result.data,
                shipingCost = parseFloat(data[0].value),
                shipingFree = parseFloat(data[1].value);

            $(".lblShipCost").html("$0.00");

            if(grantotal < shipingFree){
                $(".lblShipCost").html(formatter.format(shipingCost));
                grantotal += shipingCost;
                ship_price = shipingCost;
            }

            $("#lblTotal").html(`<strong>${formatter.format(grantotal)}</strong>`);
        });
    }
</script>

<script>
    paypal.Buttons({
        // Sets up the transaction when a payment button is clicked
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: grantotal
                    }
                }]
            });
        },
        // Finalize the transaction after payer approval
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(orderData) {
                if(orderData.status == "COMPLETED"){
                    let objData = {
                        "_method":"_POST",
                        "amount": grantotal,
                        "ship_price": ship_price,
                        "shipping_address": JSON.stringify(orderData.purchase_units[0].shipping.address),
                        "payment_data": JSON.stringify(orderData),
                        "order": JSON.stringify(orderDetails)
                    };

                    $.post("../core/controllers/checkout.php", objData, function(result) {
                        localStorage.removeItem("currentCart");
                        window.location.replace(`../order/index.html?orderId=${result.id}`);
                    });
                }else{
                    alert("Payment was not processed correctly, please try again.");
                }
            });
        }
    }).render('#paypal-button-container');
</script>
  </body>
</html>